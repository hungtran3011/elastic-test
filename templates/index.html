<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elastic Search - Thư Viện Truyện</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body data-theme="dark">
    <header>
        <div class="container" style="padding: 0;">
            <h1 style="font-size: 3rem; margin-bottom: 1rem;">Elastic Search</h1>
            <p style="opacity: 0.9;">Khám phá hàng triệu chương truyện với tốc độ ánh sáng</p>
        </div>
    </header>

    <div class="container">
        <form action="/search" method="get" class="search-box">
            <div class="search-input-wrap">
                <input id="searchInput" type="text" name="query" placeholder="Tìm kiếm tên truyện, tác giả hoặc nội dung..."
                    value="{{ query or '' }}" required autocomplete="off" spellcheck="false" autofocus>
                <div id="autocomplete" class="autocomplete-list" role="listbox" aria-label="Gợi ý tìm kiếm" hidden></div>
            </div>
            <select id="scopeSelect" name="scope" aria-label="Tìm trong">
                <option value="all" {% if scope == 'all' %}selected{% endif %}>Tất cả</option>
                <option value="title" {% if scope == 'title' %}selected{% endif %}>Tên truyện</option>
                <option value="content" {% if scope == 'content' %}selected{% endif %}>Nội dung</option>
            </select>
            <button type="submit">Tìm Kiếm</button>
        </form>

        {% if results is not none %}
        <div class="stats">
            Tìm thấy khoảng <strong>{{ total_hits }}</strong> kết quả
        </div>

        {% for hit in results %}
        <div class="result-card">
            <h3>
                {% if hit._source.doc_type == 'chapter' %}
                {% if hit.story_title %}
                <a href="/document/{{ hit.story_slug }}" style="color: var(--primary); text-decoration: none;">{{
                    hit.story_title }}</a>
                <span style="color: var(--text-muted); margin: 0 8px; font-weight: 400; font-size: 0.9em;">&gt;</span>
                {% endif %}
                <a href="/document/{{ hit._id }}" style="color: inherit; text-decoration: none;">
                    Chương {{ hit._source.chapter_number }}{% if hit.total_chapters %}/{{ hit.total_chapters }}{% endif
                    %}
                </a>
                {% else %}
                <a href="/document/{{ hit._id }}" style="color: inherit; text-decoration: none;">
                    {% if hit.highlight and hit.highlight.title %}
                    {% for fragment in hit.highlight.title %}
                    {{ fragment | safe }}
                    {% endfor %}
                    {% else %}
                    {{ hit._source.title }}
                    {% endif %}
                </a>
                {% endif %}
            </h3>

            <!-- Tech Metadata -->
            <div
                style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.8rem; display: flex; gap: 15px; opacity: 0.7;">
                <span><strong>ID:</strong> {{ hit._id }}</span>
                <span><strong>Score:</strong> {{ "%.4f"|format(hit._score) }}</span>
            </div>

            <div class="snippet">
                <a href="/document/{{ hit._id }}" style="text-decoration: none; color: inherit;">
                    {% if hit.highlight and hit.highlight.content %}
                    {% for fragment in hit.highlight.content %}
                    ... {{ fragment | safe }} ...
                    {% endfor %}
                    {% else %}
                    {{ (hit._source.content[:300] if hit._source.content else '') | replace('&lt;br&gt;', '<br>') | safe
                    }}...
                    {% endif %}
                </a>
            </div>
        </div>
        {% endfor %}

        {% if not results %}
        <div style="text-align: center; padding: 4rem; opacity: 0.5;">
            <p>Không tìm thấy kết quả nào cho "{{ query }}"</p>
        </div>
        {% endif %}

        {% if total_pages and total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="/search?query={{ query|urlencode }}&scope={{ scope|urlencode }}&page={{ page - 1 }}">Trước</a>
            {% endif %}

            {% for p in pages %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% else %}
            <a href="/search?query={{ query|urlencode }}&scope={{ scope|urlencode }}&page={{ p }}">{{ p }}</a>
            {% endif %}
            {% endfor %}

            {% if page < total_pages %} <a href="/search?query={{ query|urlencode }}&scope={{ scope|urlencode }}&page={{ page + 1 }}">Sau</a>
                {% endif %}
        </div>
        {% endif %}
        {% else %}
        <!-- Landing suggestions or categories would go here -->
        <div style="text-align: center; padding: 4rem; opacity: 0.5;">
            <p>Nhập từ khóa để bắt đầu khám phá</p>
        </div>
        {% endif %}
    </div>

    <footer style="text-align: center; padding: 4rem; color: var(--text-muted); font-size: 0.8rem;">
        &copy; 2026 Powered by Elasticsearch & FastAPI
    </footer>

    <script>
        (function () {
            const input = document.getElementById('searchInput');
            const list = document.getElementById('autocomplete');
            const scopeSelect = document.getElementById('scopeSelect');
            if (!input || !list) return;

            let debounceTimer = null;
            let activeIndex = -1;
            let items = [];
            let lastQuery = '';

            function hide() {
                list.hidden = true;
                list.innerHTML = '';
                activeIndex = -1;
                items = [];
            }

            function autocompleteEnabled() {
                return !scopeSelect || scopeSelect.value !== 'content';
            }

            function show() {
                list.hidden = false;
            }

            function render(suggestions) {
                items = suggestions || [];
                activeIndex = -1;
                if (!items.length) {
                    hide();
                    return;
                }

                list.innerHTML = items.map((s, idx) => (
                    `<div class="autocomplete-item" role="option" data-idx="${idx}">${escapeHtml(s.title)}</div>`
                )).join('');
                show();
            }

            function escapeHtml(str) {
                return (str || '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function setActive(nextIdx) {
                const children = Array.from(list.querySelectorAll('.autocomplete-item'));
                children.forEach(el => el.classList.remove('active'));
                activeIndex = nextIdx;
                if (activeIndex >= 0 && activeIndex < children.length) {
                    const el = children[activeIndex];
                    el.classList.add('active');
                    el.scrollIntoView({ block: 'nearest' });
                }
            }

            function select(idx, submit = false) {
                if (idx < 0 || idx >= items.length) return;
                input.value = items[idx].title;
                hide();
                if (submit) {
                    input.form && input.form.requestSubmit ? input.form.requestSubmit() : input.form && input.form.submit();
                }
            }

            async function fetchSuggestions(q) {
                const url = `/autocomplete?query=${encodeURIComponent(q)}&limit=8`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return [];
                const data = await res.json();
                return data && data.suggestions ? data.suggestions : [];
            }

            input.addEventListener('input', () => {
                const q = input.value.trim();
                lastQuery = q;

                if (debounceTimer) clearTimeout(debounceTimer);
                if (!autocompleteEnabled()) {
                    hide();
                    return;
                }
                if (q.length < 2) {
                    hide();
                    return;
                }

                debounceTimer = setTimeout(async () => {
                    try {
                        if (!autocompleteEnabled()) {
                            hide();
                            return;
                        }
                        const current = input.value.trim();
                        if (current.length < 2) {
                            hide();
                            return;
                        }
                        const suggestions = await fetchSuggestions(current);
                        // Ignore late responses.
                        if (input.value.trim() !== current) return;
                        render(suggestions);
                    } catch (_) {
                        hide();
                    }
                }, 180);
            });

            if (scopeSelect) {
                scopeSelect.addEventListener('change', () => {
                    hide();
                });
            }

            input.addEventListener('keydown', (e) => {
                if (list.hidden) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setActive(Math.min(items.length - 1, activeIndex + 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setActive(Math.max(0, activeIndex - 1));
                } else if (e.key === 'Enter') {
                    if (activeIndex >= 0) {
                        e.preventDefault();
                        select(activeIndex, true);
                    }
                } else if (e.key === 'Escape') {
                    hide();
                }
            });

            list.addEventListener('mousedown', (e) => {
                // mousedown (not click) so the input doesn't lose focus before we read target.
                const item = e.target.closest('.autocomplete-item');
                if (!item) return;
                const idx = parseInt(item.getAttribute('data-idx') || '-1', 10);
                if (!Number.isFinite(idx)) return;
                select(idx, true);
            });

            document.addEventListener('click', (e) => {
                if (e.target === input) return;
                if (e.target.closest('.search-input-wrap')) return;
                hide();
            });
        })();
    </script>
</body>

</html>
